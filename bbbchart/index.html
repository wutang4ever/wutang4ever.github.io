<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chart Converter</title>

    <style type="text/css" media="all">
        @import url("styles/wget-styles/system.base.css");
        @import url("styles/wget-styles/system.menus.css");
        @import url("styles/wget-styles/system.messages.css");
        @import url("styles/wget-styles/system.theme.css");
    </style>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/jquery.ui.core.min.css");
        @import url("styles/wget-styles/jquery.ui.theme.min.css");
        @import url("styles/wget-styles/jquery.ui.datepicker.min.css");
    </style>
    <link type="text/css" rel="stylesheet" href="styles/wget-styles/jquery.timeentry.css" media="all"/>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/date.css");
        @import url("styles/wget-styles/datepicker.1.7.css");
        @import url("styles/wget-styles/field.css");
        @import url("styles/wget-styles/node.css");
        @import url("styles/wget-styles/user.css");
        @import url("styles/wget-styles/user-alert.css");
        @import url("styles/wget-styles/views.css");
    </style>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/apachesolr_autocomplete.css");
        @import url("styles/wget-styles/jquery.autocomplete.css");
        @import url("styles/wget-styles/colorbox_default_style.css");
        @import url("styles/wget-styles/ctools.css");
        @import url("styles/wget-styles/printlinks.css");
        @import url("styles/wget-styles/paywall.css");
    </style>
    <style type="text/css" media="screen">
        @import url("styles/wget-styles/common.css");
        @import url("styles/wget-styles/application.css");
        @import url("styles/wget-styles/header.css");
        @import url("styles/wget-styles/headers.css");
        @import url("styles/wget-styles/footer.css");
        @import url("styles/wget-styles/social.css");
        @import url("styles/wget-styles/genericons.css");
        @import url("styles/wget-styles/teaser.css");
        @import url("styles/wget-styles/gallery.css");
        @import url("styles/wget-styles/most_popular.css");
        @import url("styles/wget-styles/newsletter.css");
        @import url("styles/wget-styles/pull_quote.css");
        @import url("styles/wget-styles/rating.css");
        @import url("styles/wget-styles/rating2.css");
        @import url("styles/wget-styles/chart.css");
        @import url("styles/wget-styles/charts.css");
        @import url("styles/wget-styles/chart_summary.css");
        @import url("styles/wget-styles/chart_legend.css");
        @import url("styles/wget-styles/search.css");
        @import url("styles/wget-styles/album.css");
        @import url("styles/wget-styles/on_tour.css");
        @import url("styles/wget-styles/forms.css");
        @import url("styles/wget-styles/archive.css");
        @import url("styles/wget-styles/linkedin.css");
        @import url("styles/wget-styles/inline_promo.css");
        @import url("styles/wget-styles/pushdown_promo.css");
        @import url("styles/wget-styles/video.css");
        @import url("styles/wget-styles/artist.css");
        @import url("styles/wget-styles/article.css");
        @import url("styles/wget-styles/tertiary.css");
        @import url("styles/wget-styles/landing-page.css");
    </style>
    <style type="text/css" media="screen">
        @import url("styles/wget-styles/landing-page-biz.css");
        @import url("styles/wget-styles/home-page.css");
        @import url("styles/wget-styles/search_results.css");
        @import url("styles/wget-styles/milestone.css");
        @import url("styles/wget-styles/bbma.css");
        @import url("styles/wget-styles/select2.css");
        @import url("styles/wget-styles/select2_overrides.css");
        @import url("styles/wget-styles/event-page.css");
        @import url("styles/wget-styles/watch_embed.css");
        @import url("styles/wget-styles/swiper.css");
        @import url("styles/wget-styles/magnific-popup.css");
    </style>
    <style type="text/css" media="print">
        @import url("styles/wget-styles/billboard-print.css");
    </style>



    <style>
    </style>
</head>
<body>

<div id="wall" align="center">
    <label>Enter password:</label>
    <input type="password" id="pass" style="width:400px;"/>
    <button id="authenticate">Enter</button>
    <div id="wrongPass" hidden="true">Wrong password!</div>
</div>

<div id="open" hidden="true">
    <div id="chartSelect" align="center">
        <label>Enter URL:</label>
        <input type="text" id="chartURL" style="width:400px;"/><br>
        <label>Or select:</label>
        <select id="chart-select" style="width:300px;">
            <option value="">Select chart</option>
        </select>
        <select id="date-select" style="width:100px;">
            <option value="">Select date</option>
        </select>
        <label>Or paste HTML code (open chart in browser, press Ctrl+U, copy all code)</label>
        <input type="textarea" id="chartHtml" style="width:400px;height:100px;"/><br>
        <br>
        <div style="width:50%; margin-bottom: 3px;">The new format conversion works now,
            but there seems to be no information about W2 or Label/Imprint in the new format,
            so these fields are excluded. There have also been ongoing "network" issues as I have been using various public (free) CORS proxies to fetch the data,
            and they are always heavily rate limited and unreliable.
            So in case of Server Error just try again later. And pasting HTML code will always work even in case of network issues.
            </div>
        <div style="width:50%; margin-bottom: 3px;">
            Now you can choose CORS proxy from the list below. Proxy 1 is the most reliable, but requires one extra step to do
            each time when you haven't used the tool for some time - go to
            <a href="https://cors-anywhere.herokuapp.com/corsdemo">https://cors-anywhere.herokuapp.com/corsdemo</a>
            and click "Request temporary access to the demo server" button. Proxy 2 and Proxy 3 don't need that but are much less reliable.
        </div>
        <br>
        <select id="choose-proxy" style="width:300px;">
            <option label="Proxy 1" value="https://cors-anywhere.herokuapp.com/"></option>
            <option label="Proxy 2" value="https://api.allorigins.win/get?url="></option>
            <option label="Proxy 3" value="https://api.codetabs.com/v1/proxy?quest="></option>
        </select>
        <br><br>
        <button id="getChart">Get Text</button> <button id="getBizChart">Get Biz Layout</button> <button id="getExcelFile">Get Excel File</button> <button id="clear">Clear All</button>
        <br><br>
        <div id="userMessage"></div><br><br>
    </div>

    <div id="hiddenChart" hidden="true"></div>
    <div id="hiddenChartPos" hidden="true"></div>

    <div id="textChartRoot" align="center">
        <textarea id="textAreaOutput" hidden="true" style="width: 800px; height: 1200px;"></textarea>
    </div>

    <div id="bizChartRoot" hidden="true">

        <div id="bb" class="bbbiz" data-behavior="bbbiz">
            <div class="full_width">
                <div class="page-title">
                    <h1 class="title" id="page-title">The Billboard Hot 100</h1>
                </div>
                <div class="header_intro">This week's most popular songs across all genres, ranked by radio airplay audience impressions as measured by Nielsen Music, sales data as compiled by Nielsen Music and streaming activity data provided by online music sources.</div>
                <div class="tabs"></div>
            </div>
            <div id="main-wrapper"><div id="main" class="clearfix">
                <div id="content" class="column with_sidebar_second" role="main"><div class="section">
                    <div class="region region-content">
                        <div id="block-system-main" class="block block-system">
                            <div class="content">
                                <table class="charts_table" data-behavior="charts_table">
                                    <thead>
                                    <tr>
                                        <th scope="col">Two Weeks</th>
                                        <th scope="col">Last Week</th>
                                        <th scope="col">This Week</th>
                                        <th></th> <th scope="col">
                                        RIAA certification
                                    </th>
                                        <th scope="col">Peak Pos.</th>
                                        <th scope="col">Weeks on Chart</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div></div>

            </div>


            </div>
        </div>
    </div>
</div>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/xlsx.full.min.js"></script>
<script>

    var date = '';

    var CHARTS = [
        ['hot-100'],
        ['billboard-global-200'],
        ['billboard-global-excl-us'],
        ['r-b-hip-hop-songs'],
        ['bubbling-under-hot-100-singles'],
        ['r-and-b-songs'],
        ['country-songs'],
        ['rock-songs'],
        ['hot-alternative-songs'],
        ['hot-hard-rock-songs'],
        ['dance-electronic-songs'],
        ['digital-song-sales'],
        ['r-and-b-hip-hop-digital-song-sales'],
        ['rap-digital-song-sales'],
        ['r-and-b-digital-song-sales'],
        ['country-digital-song-sales'],
        ['rock-digital-song-sales'],
        ['alternative-digital-song-sales'],
        ['hard-rock-digital-song-sales'],
        ['dance-electronic-digital-song-sales'],
        ['pop-songs'],
        ['adult-pop-songs'],
        ['adult-contemporary'],
        ['hot-r-and-b-hip-hop-airplay'],
        ['mainstream-r-and-b-hip-hop'],
        ['hot-adult-r-and-b-airplay'],
        ['rhythmic-40'],
        ['country-airplay'],
        ['rock-airplay'],
        ['alternative-airplay'],
        ['hot-mainstream-rock-tracks'],
        ['triple-a'],
        ['hot-dance-airplay'],
        ['dance-club-play-songs'],
        ['latin-songs'],
        ['radio-songs'],
        ['streaming-songs'],
        ['on-demand-songs'],
        ['pop-digital-song-sales'],
        ['bubbling-under-r-and-b-hip-hop-singles'],

        ['billboard-200'],
        ['top-album-sales'],
        ['current-albums'],
        ['tastemaker-albums'],
        ['country-albums'],
        ['americana-folk-albums'],
        ['bluegrass-albums'],
        ['r-b-hip-hop-albums'],
        ['rap-albums'],
        ['r-and-b-albums'],
        ['rock-albums'],
        ['hard-rock-albums'],
        ['alternative-albums'],
        ['dance-electronic-albums'],
        ['blues-albums'],
        ['jazz-albums'],
        ['traditional-jazz-albums'],
        ['contemporary-jazz'],
        ['new-age-albums'],
        ['reggae-albums'],
        ['heatseekers-albums'],
        ['independent-albums'],
        ['soundtracks'],
        ['compilation-albums'],
        ['cast-albums'],
        ['vinyl-albums'],

        ['alternative-album-sales'],
        ['americana-folk-album-sales'],
        ['artist-100'],
        ['blues-digital-song-sales'],
        ['catalog-album-sales'],
        ['country-album-sales'],
        ['country-catalog-albums'],
        ['country-streaming-songs'],
        ['dance-electronic-album-sales'],
        ['dance-electronic-streaming-songs'],
        ['digital-albums'],
        ['hard-rock-album-sales'],
        ['heatseekers-songs'],
        ['hot-holiday-songs'],
        ['hot-rap-tracks'],
        ['jazz-digital-song-sales'],
        ['jazz-songs'],
        ['latin-album-sales'],
        ['latin-albums'],
        ['new-age-digital-song-sales'],
        ['r-and-b-hip-hop-catalog-albums'],
        ['r-and-b-hip-hop-streaming-songs'],
        ['r-and-b-streaming-songs'],
        ['randb-album-sales'],
        ['randb-hip-hop-album-sales'],
        ['rap-album-sales'],
        ['rap-song'],
        ['rap-streaming-songs'],
        ['reggae-digital-song-sales'],
        ['rock-album-sales'],
        ['rock-streaming-songs'],
        ['soundtrack-sales'],
        ['world-albums'],
        ['world-digital-song-sales']
    ];

    function parseChartUsNew(htmlChart) {
        var title = $('.chart-results > div > div > div > h2').text().trim();
        var date = $('.chart-results > div > div > p').text().trim();
        var criteria = '';
        var description = '';
        var positions = [];
        $('#hiddenChart').find('.o-chart-results-list-row-container').each(function() {
            var nodes = $(this).find('.o-chart-results-list__item');
            var w2 = '';
            var w1 = $(nodes[6]).text().trim();
            var pos = $(nodes[0]).find('span:nth-child(1)').text().trim();
            // var gainer = $(this).find('.item-details__gainer').text().trim();
            var title = $(nodes[3]).find('#title-of-a-story').text().trim();
            var artist = $(nodes[3]).find('span').text().trim();
            var credits = '';
            var label = '';
            var cert = '';
            var weeks = $(nodes[8]).text().trim();
            var peak = $(nodes[7]).text().trim();
            var p = {
                w2: w2,
                w1: w1,
                pos: pos,
                cert: cert,
                weeks: weeks,
                // gainer: gainer,
                title: title,
                artist: artist,
                credits: credits,
                label: label,
                peak: peak
            };
            positions.push(p);
        });

        return {
            title: title,
            date: date,
            criteria: criteria,
            description: description,
            positions: positions
        };
    }

    function parseChart(htmlChart) {
        var mainView = htmlChart.slice(htmlChart.indexOf('<main'), htmlChart.indexOf('</main>') + 7);
        $('#hiddenChart').html(preventJS(mainView));
        return parseChartUsNew(htmlChart);
    }

    function preventJS(html) {
        var wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        $(wrapper).find('script').remove();
        return wrapper
    }

    function parseChartUK(htmlChart) {
        var headerView = htmlChart.slice(htmlChart.indexOf('<section class="gutter'));
        headerView = headerView.slice(0, headerView.indexOf('</section>') + 7);
        $('#hiddenChart').html(preventJS(headerView));
        var title = $('.prose > h1').clone().children().remove().end().text().trim();
        var date = $('.prose > p').first().text().trim();
        var criteria = '';
        var description = $('.prose > div > p').text().trim();

        var mainView = htmlChart.slice(htmlChart.indexOf('<section class="chart-list'));
        mainView = mainView.slice(0, mainView.indexOf('</section>') + 7);
        $('#hiddenChart').html(preventJS(mainView));

        var positions = [];
        $('#hiddenChart').find('.chart-item-content').each(function() {
            $('#hiddenChartPos').html(this.innerHTML);
            var pos = $(this).find('.position > span > strong').text().trim();
            if (!pos) return;
            var w2 = '';
            var w1 = $(this).find('.movement > span > span').text().trim();
            var gainer = '';
            var title = $(this).find('.chart-name').find('span:nth-child(2)').text().trim();
            var artist = $(this).find('.chart-artist').text().trim();
            var credits = '';
            var label = '';
            var cert = '';
            var weeks = $(this).find('.weeks > span').text().trim();
            var peak = $(this).find('.peak > span:nth-child(1)').text().trim();
            var p = {
                w2: w2,
                w1: w1,
                pos: pos,
                cert: cert,
                weeks: weeks,
                gainer: gainer,
                title: title,
                artist: artist,
                credits: !!credits && credits.trim() === '()' ? 'Not Listed' : credits,
                label: !!label && label.trim() === '()' ? 'Not Listed' : label,
                peak: peak
            };
            positions.push(p);
        });

        return {
            title: title,
            date: date,
            criteria: criteria,
            description: description,
            positions: positions
        };
    }


    function setHtml(id, text) {
        $('#'+id).html(text);
    }

    function setTextArea(text) {
        $('#textAreaOutput').val(text);
        $('#textAreaOutput').show();
    }

    function setUserMessage(text) {
        setHtml('userMessage', text);
    }

    function validateResponse(data) {
        return data.indexOf('o-chart-results-list-row-container') > 0;
    }

    function validateResponseUK(data) {
        return data.indexOf('<section class="chart-list') > 0 && data.indexOf('chart-item-content') > 0;
    }

    function isNew(p) {
        return (p.w1 === '--' && p.w2 === '--')
            || (!!p.w1 && (p.w1.toUpperCase() === 'NEW' || p.w1.toUpperCase() === 'RE'))
            || p.w1 === '-';
    }

    function getChartText(chart) {
        var lines = [];
        lines.push(chart.title);
        lines.push(chart.date);
        // lines.push('TW LW 2W WOC Title Artist ( Peak ) Imprint | label');
        lines.push('TW LW WOC Title Artist ( Peak )');
        chart.positions.forEach(function(p) {
            var cols = [];
            cols.push(p.pos);
            if (isNew(p)) {
                if (p.weeks === '1') {
                    cols.push('NEW');
                } else {
                    cols.push('Re-Entry');
                }
            } else {
                cols.push(p.w1);
                // cols.push(p.w2);
            }
            cols.push(p.weeks);
            cols.push(p.title);
            cols.push('-');
            cols.push(p.artist);
            cols.push('(');
            cols.push(p.peak);
            cols.push(')');
            cols.push(p.label);
            lines.push(cols.join(' '));
        });
        return lines.join('\n');
    }

    function makeRow(position) {
        var tr = $('<tr>');
        if (isNew(position) && position.weeks === '1') {
            tr.attr('class', 'highlight');
        }
        var w2 = $('<td>').attr('rowspan', '2').append($('<span>').text(position.w2));
        var w1 = $('<td>').attr('rowspan', '2').append($('<span>').text(position.w1));
        var pos = $('<td>').attr('rowspan', '2').attr('class', 'this_week').append($('<span>').text(position.pos));
        var details = $('<td>').attr('rowspan', '2').attr('class', 'details')
            .html('<b>'+position.title+'</b><br/><i>'+position.artist+'</i><br/>'+position.credits+'<br/>'+position.label)
        ;
        var cert = $('<td>').attr('class', 'cert');
        var peak = $('<td>').attr('rowspan', '2').text(position.peak);
        var weeks = $('<td>').attr('rowspan', '2').text(position.weeks);
        if (position.weeks === '1') {
            tr.append('<td rowspan="2" colspan="2" class="new"><span>New</span></td>');
        } else if (position.w1 === '--' || position.w1.toUpperCase() === 'RE' || position.w1 === '-' ) {
            tr.append('<td rowspan="2" colspan="2" class="new"><span>Re-Entry</span></td>');
        } else {
            tr.append(w2).append(w1);
        }
        tr.append(pos).append(details).append(cert).append(peak).append(weeks);
        return tr;
    }

    function setBizChart(chart) {
        $('#page-title').text(chart.title);
        $('.header_intro').text(chart.description);

        var chartsTable = $('.charts_table > tbody');
        chartsTable.empty();
        chart.positions.forEach(function(p) {
            chartsTable.append(makeRow(p));
            if (isNew(p) && p.weeks === '1') {
                chartsTable.append('<tr class="highlight">\n' +
                    '                                    <td class="play"></td>\n' +
                    '                                </tr>');
            } else {
                chartsTable.append('<tr>\n' +
                    '                                    <td class="play"></td>\n' +
                    '                                </tr>');
            }
        });

        $('#bizChartRoot').show();
    }

    function download(chart) {
        var wb = XLSX.utils.book_new();
        wb.SheetNames.push("Chart");
        var ws_data = [];
        ws_data.push(['TW', 'LW', '2W', 'PEAK', 'WOC', 'TITLE', 'ARTIST', 'LABEL', 'CREDITS']);
        chart.positions.forEach(function(p) {
            ws_data.push([p.pos, p.w1, p.w2, p.peak, p.weeks, p.title, p.artist, p.label, p.credits]);
        });
        wb.Sheets["Chart"] = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.writeFile(wb, chart.title+' '+chart.date+'.xlsx');
    }

    function callback(data, format) {
        if (!validateResponse(data)) {
            setUserMessage('No chart found in response from server');
        } else {
            var chart = parseChart(data);
            if (format === 'TEXT') {
                var chartText = getChartText(chart);
                setTextArea(chartText);
            } else if (format === 'BIZ') {
                setBizChart(chart);
            } else if (format === 'XLSX') {
                download(chart);
            }
        }
    }

    function callbackUK(data, format) {
        if (!validateResponseUK(data)) {
            setUserMessage('No chart found in response from server');
        } else {
            var chart = parseChartUK(data);
            if (format === 'TEXT') {
                var chartText = getChartText(chart);
                setTextArea(chartText);
            } else if (format === 'BIZ') {
                setBizChart(chart);
            } else if (format === 'XLSX') {
                download(chart);
            }
        }
    }

    function getChartHtml(chartUrl, callback, format) {
        var proxy = $('#choose-proxy').children("option:selected").val();
        if (!proxy) {
            setUserMessage('Please choose proxy');
        }
        $.ajax({
            url:proxy+chartUrl,
            type:'GET',
            success: function(data){
                callback(data, format);
            },
            error: function(data) {
                setUserMessage('Server error');
            }
        });
    }

    function getLastSaturday() {
        var t = new Date();
        t.setDate(t.getDate() - t.getDay());
        t.setDate(t.getDate() -1);
        return t;
    }

    function plus(d, days) {
        var t = new Date(d.getTime());
        t.setDate(t.getDate()+days);
        return t;
    }

    function format(d) {
        return d.getFullYear()+'-'+("0" + (d.getMonth()+1)).slice(-2)+'-'+("0" + d.getDate()).slice(-2);
    }

    function clearAll() {
        $('#chartHtml').val('');
        $("#chartURL").val('');
    }

    function get(type) {
        setUserMessage('');
        $('#textAreaOutput').hide();
        $('#bizChartRoot').hide();
        var selectedChart = $('#chart-select').children("option:selected").val();
        var selectedDate = $('#date-select').children("option:selected").val();
        if (selectedChart !== '' && selectedDate !== '') {
            var chartUrl = 'https://www.billboard.com/charts/'+selectedChart+'/'+selectedDate;
        } else {
            var chartUrl = $("#chartURL").val();
        }
        var chartHtml = $('#chartHtml').val();
        if(!!chartHtml && !!chartHtml.trim()) {
            callback(chartHtml, type);
        }  else {
            if (chartUrl.indexOf("billboard.com/charts") > 0) {
                getChartHtml(chartUrl, callback, type);
            } else if (chartUrl.indexOf("officialcharts.com/charts") > 0) {
                getChartHtml(chartUrl, callbackUK, type);
            } else {
                setUserMessage('Incorrect URL');
            }
        }
    }

    $(document).ready(function() {
        CHARTS.forEach(function(e) {
            $("#chart-select").append($('<option>', {
                value: e[0],
                text: e[0]
            }));
        });
        var d = getLastSaturday();
        var dates = [format(plus(d,7)), format(d), format(plus(d,-7)), format(plus(d, -14)), format(plus(d, -21)), 
                     format(plus(d, -28)), format(plus(d, -35)), format(plus(d, -42)), format(plus(d, -49)), 
                     format(plus(d, -56)), format(plus(d, -63)), format(plus(d, -70)), format(plus(d, -77))];
        dates.forEach(function(e) {
            $("#date-select").append($('<option>', {
                value: e,
                text: e
            }));
        });
        $("#getChart").click(function () {
            get('TEXT');
        });
        $("#getBizChart").click(function () {
            get('BIZ');
        });
        $("#getExcelFile").click(function () {
            get('XLSX');
        });
        $("#clear").click(function () {
            clearAll();
        });
        $('#authenticate').click(function() {
            var pass = $("#pass").val();
            if (pass === "chamber36") {
                $("#wall").hide();
                $("#open").show();
            } else {
                $("#wrongPass").show();
            }
        });
        $("#pass").on("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                $("#authenticate").click();
            }
        });
    });
</script>
</body>
</html>
