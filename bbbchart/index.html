<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chart Converter</title>

    <style type="text/css" media="all">
        @import url("styles/wget-styles/system.base.css");
        @import url("styles/wget-styles/system.menus.css");
        @import url("styles/wget-styles/system.messages.css");
        @import url("styles/wget-styles/system.theme.css");
    </style>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/jquery.ui.core.min.css");
        @import url("styles/wget-styles/jquery.ui.theme.min.css");
        @import url("styles/wget-styles/jquery.ui.datepicker.min.css");
    </style>
    <link type="text/css" rel="stylesheet" href="styles/wget-styles/jquery.timeentry.css" media="all"/>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/date.css");
        @import url("styles/wget-styles/datepicker.1.7.css");
        @import url("styles/wget-styles/field.css");
        @import url("styles/wget-styles/node.css");
        @import url("styles/wget-styles/user.css");
        @import url("styles/wget-styles/user-alert.css");
        @import url("styles/wget-styles/views.css");
    </style>
    <style type="text/css" media="all">
        @import url("styles/wget-styles/apachesolr_autocomplete.css");
        @import url("styles/wget-styles/jquery.autocomplete.css");
        @import url("styles/wget-styles/colorbox_default_style.css");
        @import url("styles/wget-styles/ctools.css");
        @import url("styles/wget-styles/printlinks.css");
        @import url("styles/wget-styles/paywall.css");
    </style>
    <style type="text/css" media="screen">
        @import url("styles/wget-styles/common.css");
        @import url("styles/wget-styles/application.css");
        @import url("styles/wget-styles/header.css");
        @import url("styles/wget-styles/headers.css");
        @import url("styles/wget-styles/footer.css");
        @import url("styles/wget-styles/social.css");
        @import url("styles/wget-styles/genericons.css");
        @import url("styles/wget-styles/teaser.css");
        @import url("styles/wget-styles/gallery.css");
        @import url("styles/wget-styles/most_popular.css");
        @import url("styles/wget-styles/newsletter.css");
        @import url("styles/wget-styles/pull_quote.css");
        @import url("styles/wget-styles/rating.css");
        @import url("styles/wget-styles/rating2.css");
        @import url("styles/wget-styles/chart.css");
        @import url("styles/wget-styles/charts.css");
        @import url("styles/wget-styles/chart_summary.css");
        @import url("styles/wget-styles/chart_legend.css");
        @import url("styles/wget-styles/search.css");
        @import url("styles/wget-styles/album.css");
        @import url("styles/wget-styles/on_tour.css");
        @import url("styles/wget-styles/forms.css");
        @import url("styles/wget-styles/archive.css");
        @import url("styles/wget-styles/linkedin.css");
        @import url("styles/wget-styles/inline_promo.css");
        @import url("styles/wget-styles/pushdown_promo.css");
        @import url("styles/wget-styles/video.css");
        @import url("styles/wget-styles/artist.css");
        @import url("styles/wget-styles/article.css");
        @import url("styles/wget-styles/tertiary.css");
        @import url("styles/wget-styles/landing-page.css");
    </style>
    <style type="text/css" media="screen">
        @import url("styles/wget-styles/landing-page-biz.css");
        @import url("styles/wget-styles/home-page.css");
        @import url("styles/wget-styles/search_results.css");
        @import url("styles/wget-styles/milestone.css");
        @import url("styles/wget-styles/bbma.css");
        @import url("styles/wget-styles/select2.css");
        @import url("styles/wget-styles/select2_overrides.css");
        @import url("styles/wget-styles/event-page.css");
        @import url("styles/wget-styles/watch_embed.css");
        @import url("styles/wget-styles/swiper.css");
        @import url("styles/wget-styles/magnific-popup.css");
    </style>
    <style type="text/css" media="print">
        @import url("styles/wget-styles/billboard-print.css");
    </style>



    <style>
    </style>
</head>
<body>

<div id="wall" align="center">
    <label>Enter password:</label>
    <input type="password" id="pass" style="width:400px;"/>
    <button id="authenticate">Enter</button>
    <div id="wrongPass" hidden="true">Wrong password!</div>
</div>

<div id="open" hidden="true">
    <div id="chartSelect" align="center">
        <label>Enter URL:</label>
        <input type="text" id="chartURL" style="width:400px;"/><br>
        <label>Or select:</label>
        <select id="chart-select" style="width:300px;">
            <option value="">Select chart</option>
        </select>
        <select id="date-select" style="width:100px;">
            <option value="">Select date</option>
        </select>
        <label>Or paste HTML code (open chart in browser, press Ctrl+U, copy all code)</label>
        <input type="textarea" id="chartHtml" style="width:400px;height:100px;"/><br>
        <br><br>
        <button id="getChart">Get Text</button> <button id="getBizChart">Get Biz Layout</button> <button id="getExcelFile">Get Excel File</button> <button id="clear">Clear All</button>
        <br><br>
        <div id="userMessage"></div><br><br>
        <!--    <input type="textarea" id="textAreaOutput" hidden="true" style="width: 400px; height: 1200px;"/>-->
    </div>

    <div id="hiddenChart" hidden="true"></div>
    <div id="hiddenChartPos" hidden="true"></div>

    <div id="textChartRoot" align="center">
        <textarea id="textAreaOutput" hidden="true" style="width: 800px; height: 1200px;"></textarea>
    </div>

    <div id="bizChartRoot" hidden="true">

        <div id="bb" class="bbbiz" data-behavior="bbbiz">
            <div class="full_width">
                <!--            <ul class="header_meta">-->
                <!--                <li class="prev"><a href="/web/20190719160117/https://www.billboard.com/biz/charts/2019-07-13/the-billboard-hot-100">Last week</a></li>-->
                <!--                <li><span class="chart_date">July 20, 2019</span></li>-->
                <!--                <li class="next"><span>Next week</span></li>-->
                <!--            </ul>-->
                <!--            <div class="comment-print">-->
                <!--                <a class="print" title="print" href="#print">Print</a>-->
                <!--            </div>-->
                <div class="page-title">
                    <h1 class="title" id="page-title">The Billboard Hot 100</h1>
                    <!--                <div class="social">-->
                    <!--                    <ul class="with_buttons">-->
                    <!--                        <li>-->
                    <!--                            <span class="ib in">2</span>-->
                    <!--                            <div><script type="IN/Share" data-url="http://www.billboard.com/biz/charts/the-billboard-hot-100"></script></div>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <span class="ib fb">35</span>-->
                    <!--                            <div class="fb-like" data-href="http://www.billboard.com/biz/charts/the-billboard-hot-100" data-send="false" data-layout="button_count" data-width="300" data-show-faces="true"></div> </li>-->
                    <!--                        <li>-->
                    <!--                            <span class="ib tw">20</span>-->
                    <!--                            <div class="tweetbutton-tweet tweetbutton"><a href="http://web.archive.org/web/20190719160117/https://twitter.com/share" data-size="medium" data-count="none" data-via="billboardbiz" data-related=":" data-text="" data-counturl="http://www.billboard.com/biz/charts/the-billboard-hot-100" data-url="http://web.archive.org/web/20190719160117/http://www.billboard.com/biz/charts/the-billboard-hot-100" data-lang="en" class="twitter-share-button"></a></div> </li>-->
                    <!--                        <li>-->
                    <!--                            <span class="ib gplus">4</span>-->
                    <!--                            <div class="g-plusone-wrapper"><div class="g-plusone" data-href="http://www.billboard.com/biz/charts/the-billboard-hot-100" data-size="medium" data-annotation="none"></div></div> </li>-->
                    <!--                    </ul>-->
                    <!--                    <div class="cleaner"></div>-->
                    <!--                </div>-->
                </div>
                <div class="header_intro">This week's most popular songs across all genres, ranked by radio airplay audience impressions as measured by Nielsen Music, sales data as compiled by Nielsen Music and streaming activity data provided by online music sources.</div>
                <div class="tabs"></div>
            </div>
            <div id="main-wrapper"><div id="main" class="clearfix">
                <div id="content" class="column with_sidebar_second" role="main"><div class="section">
                    <div class="region region-content">
                        <div id="block-system-main" class="block block-system">
                            <div class="content">
                                <table class="charts_table" data-behavior="charts_table">
                                    <thead>
                                    <tr>
                                        <th scope="col">Two Weeks</th>
                                        <th scope="col">Last Week</th>
                                        <th scope="col">This Week</th>
                                        <th></th> <th scope="col">
                                        RIAA certification
                                    </th>
                                        <th scope="col">Peak Pos.</th>
                                        <th scope="col">Weeks on Chart</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                                <!--                            <div class="paywall_banner">-->
                                <!--                                <h2>Subscribe to billboard biz to continue reading this chart and thousands more.</h2>-->
                                <!--                                <span>Billboard.biz subscribers get:</span>-->
                                <!--                                <ul>-->
                                <!--                                    <li>24/7 coverage of every genre and sector of the business with over 150 exclusive charts</li>-->
                                <!--                                    <li>Bulletin: Breaking stories, chart info and analysis sent directly to your inbox every weekday</li>-->
                                <!--                                    <li class="cleaner">Billboard Magazine iPad Edition: An enhanced version of the magazine with video, photo galleries and playable charts</li>-->
                                <!--                                    <li>Archives: A rich history of Billboard.biz articles and exclusive charts</li>-->
                                <!--                                </ul> <p class="cta">-->
                                <!--                                <a href="/web/20190719160117/https://www.billboard.com/subscribe" target="_blank">Join now</a>-->
                                <!--                                or-->
                                <!--                                <a href="/web/20190719160117/https://www.billboard.com/login-popup/nojs" class="use-ajax">Log In</a> </p>-->
                                <!--                                <a href="/web/20190719160117/https://www.billboard.com/biz" class="logo">billboard biz</a>-->
                                <!--                            </div>-->
                                <!--                            <div class="paywall_banner_back">-->
                                <!--                            </div> -->
                            </div>
                        </div>
                    </div>
                </div></div>

            </div>


            </div>
        </div>
    </div>
</div>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/xlsx.full.min.js"></script>
<script>

    var date = '';

    var CHARTS = [
        ['the-billboard-hot-100','1958-08-04'],
        ['bubbling-under-hot-100-singles','1992-12-05'],
        ['r-b-hip-hop-songs','1958-01-20'],
        ['bubbling-under-r-and-b-hip-hop-singles','1992-12-05'],
        ['r-and-b-songs','2012-10-20'],
        ['country-songs','1958-10-20'],
        ['radio-songs','1990-11-03'],
        ['digital-song-sales','2004-10-30'],
        ['pop-digital-song-sales','2010-01-23'],
        ['r-and-b-hip-hop-digital-song-sales','2010-01-23'],
        ['rap-digital-song-sales','2010-01-23'],
        ['r-and-b-digital-song-sales','2012-11-10'],
        ['country-digital-song-sales','2010-01-23'],
        ['pop-songs','1992-10-03'],
        ['adult-pop-songs','1995-10-07'],
        ['adult-contemporary','1961-07-17'                           ],
        ['hot-r-and-b-hip-hop-airplay','1992-04-04'],
        ['mainstream-r-and-b-hip-hop','1993-09-18'],
        ['hot-adult-r-and-b-airplay','1993-09-18'],
        ['rhythmic-40','1992-10-03'],
        ['country-airplay','1990-01-20'],
        ['rock-songs','2009-06-20'],
        ['hard-rock-digital-song-sales','2011-01-22'],
        ['alternative-digital-song-sales','2011-01-22'],
        ['rock-digital-song-sales','2010-01-23'],
        ['rock-airplay','2009-06-20'],
        ['alternative-songs','1988-09-10'],
        ['hot-mainstream-rock-tracks','1981-03-21'],
        ['triple-a','1996-01-20'],
        ['dance-electronic-songs','2013-01-26'],
        ['dance-electronic-digital-song-sales','2010-01-23'],
        ['hot-dance-airplay','2003-08-16'],
        ['dance-club-play-songs','1976-08-28'],
        ['latin-songs','1986-09-06'],

        ['the-billboard-200','1963-08-17'],
        ['top-album-sales','1991-05-25'],
        ['current-albums','1983-11-05'],
        ['tastemaker-albums','2005-12-03'],
        ['country-albums','1964-01-11'],
        ['americana-folk-albums','2009-12-05'],
        ['bluegrass-albums','2002-07-20'],
        ['r-b-hip-hop-albums','1965-01-30'],
        ['rap-albums','2004-06-26'],
        ['r-and-b-albums','2013-01-26'],
        ['rock-albums','2006-01-14'],
        ['hard-rock-albums','2007-07-28'],
        ['alternative-albums','2007-07-28'],
        ['dance-electronic-albums','2001-06-30'],
        ['blues-albums','1995-09-02'],
        ['jazz-albums','1993-11-13'],
        ['traditional-jazz-albums','1983-11-12'],
        ['contemporary-jazz','1987-02-28'],
        ['new-age-albums','1988-08-27'],
        ['reggae-albums','1994-02-05'],
        ['heatseekers-albums','1991-07-13'],
        ['independent-albums','2000-01-29'],
        ['soundtracks','2001-06-30'],
        ['compilation-albums','2004-10-30'],
        ['cast-albums','2006-01-14'],
        ['vinyl-albums','2011-01-22'],

        ['alternative-album-sales','2007-07-28'],
        ['americana-folk-album-sales','2009-12-05'],
        ['artist-100','2014-07-19'],
        ['blues-digital-song-sales','2010-01-23'],
        ['catalog-album-sales','1991-05-25'],
        ['country-album-sales','1991-05-25'],
        ['country-catalog-albums','1991-05-25'],
        ['country-streaming-songs','2013-04-20'],
        ['dance-electronic-album-sales','2001-06-30'],
        ['dance-electronic-streaming-songs','2013-04-20'],
        ['digital-albums','2005-09-24'],
        ['hard-rock-album-sales','2007-07-28'],
        ['heatseekers-songs','2009-07-18','2014-11-29'],
        ['hot-holiday-songs','2011-12-10'],
        ['hot-rap-tracks','1999-02-20'],
        ['jazz-digital-song-sales','2010-01-23'],
        ['jazz-songs','2005-10-22'],
        ['latin-album-sales','1993-07-10'],
        ['latin-albums','1993-07-10'],
        ['new-age-digital-song-sales','2010-01-23'],
        ['on-demand-songs','2012-03-24'],
        ['r-and-b-hip-hop-catalog-albums','1997-01-18'],
        ['r-and-b-hip-hop-streaming-songs','2013-04-20'],
        ['r-and-b-streaming-songs','2013-04-20'],
        ['randb-album-sales','2013-01-26'],
        ['randb-hip-hop-album-sales','1992-12-05'],
        ['rap-album-sales','2004-06-26'],
        ['rap-song','1989-03-11'],
        ['rap-streaming-songs','2013-04-20'],
        ['reggae-digital-song-sales','2010-01-23'],
        ['rock-album-sales','2006-01-14'],
        ['rock-streaming-songs','2013-04-20'],
        ['soundtrack-sales','2001-06-30'],
        ['streaming-songs','2013-01-26'],
        ['world-albums','1990-05-19'],
        ['world-digital-song-sales','2010-01-23']
    ];

    function parseChartFromPrintView(htmlChart) {
        // setTextArea(htmlChart);
        // return;
        var title = $('.print-chart__title').text();
        var date = $('.print-chart__week').text();
        var criteria = $('.print-chart__criteria').text();
        var description = $('.print-chart__description').text();
        // var printView = htmlChart.slice(htmlChart.indexOf('<table>'), htmlChart.indexOf('</table>') + 8);
        // $('#hiddenChart').html(printView);
        var positions = [];
        // alert($('tbody > tr').length);
        $('#hiddenChart').find('tbody > tr').each(function() {
            // if (positions.length > 2) {
            //     return;
            // }
            // $('#hiddenChartPos').html(this.innerHTML);
            var w2 = $(this).find('td:nth-child(1)').text();
            var w1 = $(this).find('td:nth-child(2)').text();
            var pos = $(this).find('td:nth-child(3)').text();
            var gainer = $(this).find('.item-details__gainer').text();
            var title = $(this).find('.item-details__title').text();
            var artist = $(this).find('.item-details__artist').text();
            var credits = $(this).find('.item-details__credits').text();
            var label = $(this).find('td:nth-child(4) div:last-child').text();
            var cert = $(this).find('td:nth-child(5)').text();
            var weeksAt1 = $(this).find('td:nth-child(6)').text();
            var weeks = $(this).find('td:nth-child(7)').text();
            var peak = weeks === '1' ? positions.length + 1 + '' : '';
            var p = {
                w2: w2,
                w1: w1,
                pos: pos,
                cert: cert,
                weeks: weeks,
                gainer: gainer,
                title: title,
                artist: artist,
                credits: !!credits && credits.trim() === '()' ? 'Not Listed' : credits,
                label: !!label && label.trim() === '()' ? 'Not Listed' : label,
                peak: peak
            };
            positions.push(p);
        });

        return {
            title: title,
            date: date,
            criteria: criteria,
            description: description,
            positions: positions
        };
    }

    function detectRenderLayout(htmlChart) {
        if (htmlChart.indexOf('chart-list-item__ministats-cell-heading') > 0) {
            return 'BIZ';
        } else {
            return 'MAIN';
        }
    }

    function parseAdditionalItemsFromRenderViewMain(chart, htmlChart) {
        var pos = $('#hiddenChart').find('.chart-list-item');
        if (pos.length !== chart.positions.length) {
            setUserMessage('WARNING: something went wrong, peak positions may be incorrect');
        }
        // note the strange class name - could be fixed later
        var l = $('#hiddenChart').find('.chart-list-item,.chart-list-item__weeks-at-one');
        var extra = 1;
        var index = -1;
        l.each(function() {
            if ($(this).hasClass('chart-list-item')) {
                extra = 0;
                index++;
            } else if ($(this).hasClass('chart-list-item__weeks-at-one')) {
                if (extra === 1) {
                    // setUserMessage("Illegal state");
                }
                if (extra === 0) {
                    chart.positions[index].peak = $(this).text();
                }
                extra = 1;
            }
        });
    }

    function parseAdditionalItemsFromRenderViewBiz(chart, htmlChart) {
        var index = 0;
        var l = $('#hiddenChart').find('.chart-list-item__ministats-cell-heading').filter(function(e) {
            return $(this).text()==='Peak';
        });
        if (l.length !== chart.positions.length) {
            setUserMessage('WARNING: something went wrong, peak positions may be incorrect');
        }
        l.each(function() {
            chart.positions[index++].peak = $(this).parent().clone().children().remove().end().text().trim();
        });

        // AWARDS
        index = 0;
        var awards = $('#hiddenChart').find('.chart-list-item__award');
        if (awards.length !== chart.positions.length) {
            setUserMessage('WARNING: something went wrong, peak positions may be incorrect');
        }
        awards.each(function() {
            chart.positions[index++].awards = $(this).html().trim();
        });
    }

    function parseAdditionalItemsFromRenderViewCommon(chart, htmlChart) {
    }

    function parseChart(htmlChart) {
        var mainView = htmlChart.slice(htmlChart.indexOf('<main'), htmlChart.indexOf('</main>') + 7);
        $('#hiddenChart').html(preventJS(mainView));
        var chart = parseChartFromPrintView(htmlChart);
        parseAdditionalItemsFromRenderViewCommon(chart, htmlChart);
        if (detectRenderLayout(htmlChart) === 'BIZ') {
            parseAdditionalItemsFromRenderViewBiz(chart, htmlChart);
        } else {
            parseAdditionalItemsFromRenderViewMain(chart, htmlChart);
        }
        return chart;
    }

    function preventJS(html) {
        // return html.replace(/<script(?=(\s|>))/i, '<script type="text/xml" ');
        var wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        $(wrapper).find('script').remove();
        return wrapper
    }

    function parseChartUK(htmlChart) {
        var mainView = htmlChart.slice(htmlChart.indexOf('<article class="page"'), htmlChart.indexOf('</article>') + 7);
        $('#hiddenChart').html(preventJS(mainView));

        var title = $('.article-heading').text().trim();
        var date = $('.article-date').first().text().trim();
        var criteria = '';
        var description = $('.chart-intro-text').text().trim();
        var positions = [];
        $('#hiddenChart').find('section>table>tbody>tr:not(".headings")').each(function() {
            $('#hiddenChartPos').html(this.innerHTML);
            var pos = $(this).find('.position').text().trim();
            if (!pos) return;
            var w2 = '';
            var w1 = $(this).find('.last-week').text().trim();
            var gainer = '';
            var title = $(this).find('.title').text().trim();
            var artist = $(this).find('.artist').text().trim();
            var credits = '';
            var label = $(this).find('.label').text().trim();
            var cert = '';
            // var weeksAt1 = $(this).find('td:nth-child(6)').text();
            var weeks = $(this).find('td:nth-child(5)').text().trim();
            var peak = $(this).find('td:nth-child(4)').text().trim();
            var p = {
                w2: w2,
                w1: w1,
                pos: pos,
                cert: cert,
                weeks: weeks,
                gainer: gainer,
                title: title,
                artist: artist,
                credits: !!credits && credits.trim() === '()' ? 'Not Listed' : credits,
                label: !!label && label.trim() === '()' ? 'Not Listed' : label,
                peak: peak
            };
            positions.push(p);
        });

        return {
            title: title,
            date: date,
            criteria: criteria,
            description: description,
            positions: positions
        };
    }


    function setHtml(id, text) {
        $('#'+id).html(text);
    }

    function setTextArea(text) {
        $('#textAreaOutput').val(text);
        $('#textAreaOutput').show();
    }

    function setUserMessage(text) {
        setHtml('userMessage', text);
    }

    function validateResponse(data) {
        return data.indexOf('<table>') > 0 && data.indexOf('chart-list-item') > 0;
    }

    function validateResponseUK(data) {
        return data.indexOf('<table') > 0 && data.indexOf('chart-positions') > 0;
    }

    function isNew(p) {
        return (p.w1 === '--' && p.w2 === '--') || (!!p.w1 && (p.w1.toUpperCase() === 'NEW' || p.w1.toUpperCase() === 'RE'));
    }

    function getChartText(chart) {
        var lines = [];
        lines.push(chart.title);
        lines.push(chart.date);
        lines.push('TW LW 2W WOC Title Artist ( Peak ) Imprint | label');
        // alert(chart.positions.length);
        chart.positions.forEach(function(p) {
            var cols = [];
            cols.push(p.pos);
            if (isNew(p)) {
                if (p.weeks === '1') {
                    cols.push('NEW');
                } else {
                    cols.push('Re-Entry');
                }
            } else {
                cols.push(p.w1);
                cols.push(p.w2);
            }
            cols.push(p.weeks);
            cols.push(p.title);
            cols.push('-');
            cols.push(p.artist);
            cols.push('(');
            cols.push(p.peak);
            cols.push(')');
            cols.push(p.label);
            // cols.push(p.awards);
            lines.push(cols.join(' '));
        });
        return lines.join('\n');
    }

    function makeRow(position) {
        var tr = $('<tr>');
        if (isNew(position) && position.weeks === '1') {
            tr.attr('class', 'highlight');
        }
        var w2 = $('<td>').attr('rowspan', '2').append($('<span>').text(position.w2));
        var w1 = $('<td>').attr('rowspan', '2').append($('<span>').text(position.w1));
        var pos = $('<td>').attr('rowspan', '2').attr('class', 'this_week').append($('<span>').text(position.pos));
        var details = $('<td>').attr('rowspan', '2').attr('class', 'details')
            .html('<b>'+position.title+'</b><br/><i>'+position.artist+'</i><br/>'+position.credits+'<br/>'+position.label)
        ;
        var cert = $('<td>').attr('class', 'cert');
        var peak = $('<td>').attr('rowspan', '2').text(position.peak);
        var weeks = $('<td>').attr('rowspan', '2').text(position.weeks);
        if (position.weeks === '1') {
            tr.append('<td rowspan="2" colspan="2" class="new"><span>New</span></td>');
        } else if (position.w1 === '--' || position.w1.toUpperCase() === 'RE') {
            tr.append('<td rowspan="2" colspan="2" class="new"><span>Re-Entry</span></td>');
        } else {
            tr.append(w2).append(w1);
        }
        tr.append(pos).append(details).append(cert).append(peak).append(weeks);
        return tr;
    }

    function setBizChart(chart) {
        $('#page-title').text(chart.title);
        $('.header_intro').text(chart.description);

        var chartsTable = $('.charts_table > tbody');
        chartsTable.empty();
        chart.positions.forEach(function(p) {
            chartsTable.append(makeRow(p));
            if (isNew(p) && p.weeks === '1') {
                chartsTable.append('<tr class="highlight">\n' +
                    '                                    <td class="play"></td>\n' +
                    '                                </tr>');
            } else {
                chartsTable.append('<tr>\n' +
                    '                                    <td class="play"></td>\n' +
                    '                                </tr>');
            }
        });

        $('#bizChartRoot').show();
    }

    function download(chart) {
        var wb = XLSX.utils.book_new();
        wb.SheetNames.push("Chart");
        var ws_data = [];
        ws_data.push(['TW', 'LW', '2W', 'PEAK', 'WOC', 'TITLE', 'ARTIST', 'LABEL', 'CREDITS']);
        chart.positions.forEach(function(p) {
            ws_data.push([p.pos, p.w1, p.w2, p.peak, p.weeks, p.title, p.artist, p.label, p.credits]);
        });
        wb.Sheets["Chart"] = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.writeFile(wb, chart.title+' '+chart.date+'.xlsx');
    }

    function callback(data, format) {
        if (!validateResponse(data)) {
            setUserMessage('No chart found in response from server');
        } else {
            var chart = parseChart(data);
            if (format === 'TEXT') {
                var chartText = getChartText(chart);
                setTextArea(chartText);
            } else if (format === 'BIZ') {
                setBizChart(chart);
            } else if (format === 'XLSX') {
                download(chart);
            }
        }
    }

    function callbackUK(data, format) {
        if (!validateResponseUK(data)) {
            setUserMessage('No chart found in response from server');
        } else {
            var chart = parseChartUK(data);
            if (format === 'TEXT') {
                var chartText = getChartText(chart);
                setTextArea(chartText);
            } else if (format === 'BIZ') {
                setBizChart(chart);
            } else if (format === 'XLSX') {
                download(chart);
            }
        }
    }

    function getChartHtml(chartUrl, callback, format) {
        $.ajax({
            url:"https://api.allorigins.win/get?url="+chartUrl,
             //headers: {
             //	'Origin': 'https://billboard.com'
             //},
            type:'GET',
            success: function(data){
                callback(data.contents, format);
            },
            error: function(data) {
                setUserMessage('Server error');
            }
        });
    }

    function getLastSaturday() {
        var t = new Date();
        t.setDate(t.getDate() - t.getDay());
        t.setDate(t.getDate() -1);
        return t;
    }

    function plus(d, days) {
        var t = new Date(d.getTime());
        t.setDate(t.getDate()+days);
        return t;
    }

    function format(d) {
        return d.getFullYear()+'-'+("0" + (d.getMonth()+1)).slice(-2)+'-'+("0" + d.getDate()).slice(-2);
    }

    function clearAll() {
        $('#chartHtml').val('');
        $("#chartURL").val('');
    }

    function get(type) {
        setUserMessage('');
        $('#textAreaOutput').hide();
        $('#bizChartRoot').hide();
        var selectedChart = $('#chart-select').children("option:selected").val();
        var selectedDate = $('#date-select').children("option:selected").val();
        if (selectedChart !== '' && selectedDate !== '') {
            var chartUrl = 'https://www.billboard.com/charts/'+selectedChart+'/'+selectedDate;
        } else {
            var chartUrl = $("#chartURL").val();
        }
        var chartHtml = $('#chartHtml').val();
        if(!!chartHtml && !!chartHtml.trim()) {
            callback(chartHtml, type);
        }  else {
            if (chartUrl.indexOf("billboard.com/charts") > 0) {
                getChartHtml(chartUrl, callback, type);
            } else if (chartUrl.indexOf("officialcharts.com/charts") > 0) {
                getChartHtml(chartUrl, callbackUK, type);
            } else {
                setUserMessage('Incorrect URL');
            }
        }
    }

    $(document).ready(function() {
        CHARTS.forEach(function(e) {
            $("#chart-select").append($('<option>', {
                value: e[0],
                text: e[0]
            }));
        });
        var d = getLastSaturday();
        var dates = [format(plus(d,7)), format(d), format(plus(d,-7)), format(plus(d, -14)), format(plus(d, -21)), 
                     format(plus(d, -28)), format(plus(d, -35)), format(plus(d, -42)), format(plus(d, -49)), 
                     format(plus(d, -56)), format(plus(d, -63)), format(plus(d, -70)), format(plus(d, -77))];
        dates.forEach(function(e) {
            $("#date-select").append($('<option>', {
                value: e,
                text: e
            }));
        });
        $("#getChart").click(function () {
            get('TEXT');
        });
        $("#getBizChart").click(function () {
            get('BIZ');
        });
        $("#getExcelFile").click(function () {
            get('XLSX');
        });
        $("#clear").click(function () {
            clearAll();
        });
        $('#authenticate').click(function() {
            var pass = $("#pass").val();
            if (pass === "chamber36") {
                $("#wall").hide();
                $("#open").show();
            } else {
                $("#wrongPass").show();
            }
        });
        $("#pass").on("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                $("#authenticate").click();
            }
        });
    });
</script>
</body>
</html>
